// Variables para el candado de la trampill
int lockDial1 = 0;
int lockDial2 = 0;
int lockDial3 = 0;
int candadoInput[3];
int candadoCount = 0;

#define SIMBOLO_CRISTIANO 0
#define SIMBOLO_ESTRELLA 1
#define SIMBOLO_LUNA 2
#define SIMBOLO_YINYANG 3
#define SIMBOLO_DHARMA 4
#define SIMBOLO_RUSA 5
#define SIMBOLO_SERBIA 6

bool candadoAbierto = false;
bool lightOn = false;
bool noteTaken = false;
bool lighterTaken = false;
bool candleLit = false;
bool flareUsed = false;
bool coatsBurned = false;
bool prophetResurrected = false;
bool reedFirstSceneDone = false;
bool lockOpened = false;
int lockDia1 = 0;
int lockDia2 = 0;
int lockDia3 = 0;
bool wheelSymbolRevealed = false;

// Puzzle ladrillos
int bricksPressedCount = 0;
enum BrickColor { eBrickGreen, eBrickRed, eBrickBlue };
BrickColor bricksSequence[3];

const int LOCK_CORRECT1 = 4; // rueda dharma
const int LOCK_CORRECT2 = 5; // cruz rusa
const int LOCK_CORRECT3 = 2; // luna islámica
#define LOCK_CORRECT1 1
#define LOCK_CORRECT2 2
#define LOCK_CORRECT3 3



function hInterruptor_Interact(Hotspot *theHotspot, CursorMode mode)
{
if (!lightOn) { 
lightOn = true;
oObject0.Transparency = 100;
Display("Encienden el interruptor y se revela la habitacion, pero la luz es tenue y fria.");
}
}

function hMesa_Interact(Hotspot *theHotspot, CursorMode mode)
{
if (!noteTaken) { 
cBarnes.Say("¡Mira!, hay una nota sobre la mesa.");
InventoryItem *it = iNota;
cPaxton.AddInventory(it);
noteTaken = true;
cPaxton.Say("“En la oscuridad una sola chispa sera necesaria para obrar el milagro”.");
cBarnes.Say("Esto tiene que ser otra prueba, tiene que haber alguna pista por aqui.");
cPaxton.Say("Entonces busquemosla.");
oNotaMesa.Visible = false;
} 
else { 
cPaxton.Say("Ya cogimos la nota."); }
}

function oNota_Interact(Object *theObject, CursorMode mode)
{
}


function oProfetaMuerta_Interact(Object *theObject, CursorMode mode)
{

  if (!lighterTaken)
  {
    cPaxton.Say("¡Mira! Tiene algo en la mano.");
    cPaxton.AddInventory(iMechero);
    lighterTaken = true;
    cBarnes.Say("¿Encendemos la vela?");
    cPaxton.Say("Hagamoslo.");
  }
  else
  {
    cPaxton.Say("Ya le quitamos el mechero.");
  }
}
function oVelaMesa_Interact()
{
  // Comprobamos si el jugador tiene el mechero O la bengala en el inventario
  // (Aunque estemos en la función del mechero, añadimos la condición de la bengala por seguridad)
  if (player.HasInventory(iMechero) || player.HasInventory(iBengala))
  {
    // Si la vela está presente en la habitación y no está encendida
    if (oVelaMesa.Visible)
    {
      candleLit = true;
      cPaxton.Say("Las velas de la tarta se  han encendido.");
     cPaxton.Say("Y acaban de formar una sombra en la pared.");
     
      
      // Aparecen la flecha y el símbolo
      oSobraFlecha.Visible = true;
      osimbolocruzrusa.Visible = true;
      
      // Entregamos la vela al inventario y quitamos el objeto de la mesa
      
      oVelaMesa.Visible = false;
    }
    else if (candleLit)
    {
      cPaxton.Say("Ya he encendido la vela.");
    }
    else
    {
      cPaxton.Say("No hay nada que encender aqui.");
    }
  }
}

function hRendija_Interact(Hotspot *theHotspot, CursorMode mode)
{
  if (!flareUsed && !cPaxton.HasInventory(iBengala))

  {
    cPaxton.Say("Mira Barnes aquí hay algo, ¡una bengala!");
    cPaxton.AddInventory(iBengala);
    oBengalaSuelo.Visible = false;
  }
  else
  {
    cPaxton.Say("Ya cogí la bengala.");
  }
}

function iBengala_UseInvOnHotspot(Hotspot *hs)
{
  if (hs == hVentana && !flareUsed)
  {
    flareUsed = true;
    cPaxton.Say("Usemosla para llamar la atencion de alguien.");
    Display("Paxton enciende la bengala, pero la ventana esta demasiado alta.");
    cBarnes.Say("Es inutil, estamos demasiado bajo para que alguien pueda ver la bengala. Sigamos probando cosas.");
  }
}
function StartReedConfrontation()
{
  // Reed vuelve
  oObject0.Transparency = 0;
  Wait(40);
  cReed.ChangeRoom(3,  331, 466);
  oObject0.Transparency = 100;
 

  cReed.Say("Como ven todo lo que dije es real...");
  cReed.Say("La muerte solo es un paso necesario para la resurreccion.");
  

  cBarnes.Say("Esto no ha sido más que un truco...");
  cBarnes.Say("Si usted está tan seguro de su teoria, ¿por que no la prueba?");

  // Señal a Paxton para atacar con las tijeras: puedes narrarlo
  Display("Barnes le hace una señal a Paxton para atacar con las tijeras...");
  oObject0.Transparency = 0;
  oMuerta.Visible=true;
   cBarnes.ChangeRoom(0); 
   oNavaja.Visible=true;
   cReed.ChangeRoom(0,  331, 466);
  
    oObject0.Transparency = 00;
  Display("El Sr. Reed corta la garganta de Barnes antes de que pueda defenderse.");
  cBarnes.Say("...");
   Wait(30);
   oObject0.Transparency = 100;
  // Opcional: cambiar sprite de Barnes a muerta o eliminar personaje
 // Room 0 = limbo
  
oMuerta.Visible=true;
Wait(80);
 oNavaja.Visible=false;
 cReed.ChangeRoom(3,  331, 466);
  Display("Paxton intenta pararle la hemorragia, pero no lo consigue y termina muriendo.");

  // Monólogo de Reed
  cReed.Say("Tu amiga era uno de ellos, no era como tu y como yo...");
  cReed.Say("Era un simple programa diseñado para mantenernos dormidos.");
  cPaxton.Say("Usted no es más que un viejo loco, nada de lo que ha pasado es real.");
  cReed.Say("Dicen que los mejores trucos de magia se realizan justo delante de nuestros ojos.");

  // Reed se va
 oObject0.Transparency = 00;
    Wait(30);
       oObject0.Transparency = 100;
  cReed.ChangeRoom(0);  // Room 0 = limbo

  // A partir de aquí, Paxton queda sola para el puzzle de la trampilla
}
function StartProphetResurrection()
{
  if (prophetResurrected) return;

  prophetResurrected = true;

  // Desaparece el cuerpo inmóvil y aparece la profeta como personaje
  oProfetaMuerta.Visible = false;
  cProfeta.ChangeRoom(3, 100, 100);
  cProfeta.x = oProfetaMuerta.X;
  cProfeta.y = oProfetaMuerta.Y;
  oObject1.Visible=true;
oObject1.Transparency=55;
  // Humo / espera
  Wait(170);
  oObject1.Visible=false;
  // Profeta se levanta y habla
  cProfeta.Say("El más alla… el cielo alejado del Infierno de la Tierra…");
  cProfeta.Say("Solo somos desconectados... Nada de esto es real.");

  // Entra el Sr. Reed por las escaleras
  cReed.ChangeRoom(3, 516, 344);
  // Coloca a Reed en la parte superior y hazlo caminar
  cReed.x = 50; // ajusta
  cReed.y = 20; // ajusta
  cReed.Walk(516, 344, eBlock); // baja al sótano, ajusta coords

  // Las hermanas retroceden asustadas
  cPaxton.Say("...");
  cBarnes.Say("...");

  // Reed y Profeta suben de nuevo y se desvanecen
  cReed.Say("...");
  cProfeta.Walk(512, 336,  eBlock);
  cReed.Walk(516, 344, eBlock);
  cProfeta.ChangeRoom(0);
  

  reedFirstSceneDone = true;

  // Después vendrá la escena de la discusión y muerte de Barnes
  StartReedConfrontation();
}

function oAbrigos_Interact()
{
  if (player.HasInventory(iMechero) || player.HasInventory(iBengala))
  {
    coatsBurned = true;
    cPaxton.Say("Probemos a prender los abrigos asi nos podrán ver de mas lejos.");
    Display("Las hermanas prenden los abrigos, llenando la habitacion de humo.");
    
    StartProphetResurrection();
  }
}





function oAlfombra_Interact()
{
 
    Display("Paxton retira la alfombra y descubre una trampilla con un candado de tres diales.");
    oAlfombra.Visible = false;
    oTrampilla.Visible = true;
    oCandado.Visible = true;
 
    cPaxton.Say("Ya retire la alfombra.");
  
}


function iVela_InteractOnHotspot(Hotspot *hs)
{
  if (hs == hMesa)
  {
    Display("Paxton coloca la vela sobre la mesa.");
    oVelaMesa.Visible = true;
    cPaxton.LoseInventory(iVela);


    Display("La sombra de la tarta forma una flecha en la pared, señalando una esquina poco iluminada.");
    hSimboloCruzRusa.Enabled = true;
  }
  else if (hs == hSimbolosCandelabro)
  {
    Display("Paxton acerca la vela a los simbolos.");
    Display("Uno de ellos, la luna islámica, brilla con mas intensidad.");
    lockDial3 = LOCK_CORRECT3;
  }
}


function hSimboloCruzRusa_Look()
{
  cPaxton.Say("Aqui hay un símbolo... parece una cruz rusa.");
  
  lockDial2 = LOCK_CORRECT2;
}

function hTablon_Look()
{
  cPaxton.Say("“En la oscuridad una sola chispa sera necesaria para obrar el milagro”.");
  cPaxton.Say("Y están tallados varios simbolos religiosos.");
}


function hTrampilla_Interact()
{
  if (!lockOpened)
  {
    
    if (lockDial1 == LOCK_CORRECT1 &&
        lockDial2 == LOCK_CORRECT2 &&
        lockDial3 == LOCK_CORRECT3)
    {
      lockOpened = true;
      Display("El candado se abre y la trampilla queda desbloqueada.");
      cPaxton.Say("No parece que vaya a ser fácil salir de aquí...");
      cPaxton.Say("Dios, me encomiendo a ti, dame valor y guíame a traves de esta prueba.");

      // Bajar por la trampilla (cambio de room)
      cPaxton.Walk(oTrampilla.X, oTrampilla.Y, eBlock);
      cPaxton.ChangeRoom(8,372,342);  // Room 0 = limbo

      
    }
    else
    {
      cPaxton.Say("Está protegido por un candado de tres símbolos. Aun no sé la combinación.");
    }
  }
  else
  {
    cPaxton.ChangeRoom(8,372,342);
  }
}

function hLadrillos_Look()
{
  cPaxton.Say("Hay ladrillos pintados en la pared.");
  cPaxton.Say("Uno verde, dos rojos y tres azules...");
}

function PushBrick(BrickColor color)
{
  // Si ya está resuelto, no hace falta seguir
  if (wheelSymbolRevealed)
  {
    cPaxton.Say("Ya active el mecanismo del muro.");
    return;
  }

  // Guardamos el color pulsado
  bricksSequence[bricksPressedCount] = color;
  bricksPressedCount++;

  // Si aún no hay 3 pulsaciones, no comprobamos nada
  if (bricksPressedCount < 3) return;

  // Comprobación del orden correcto: VERDE → ROJO → AZUL
  if (bricksSequence[0] == eBrickGreen &&
      bricksSequence[1] == eBrickRed &&
      bricksSequence[2] == eBrickBlue)
  {
    wheelSymbolRevealed = true;

    Display("El muro se resquebraja y aparece el simbolo de la rueda dharma.");

    // Asegúrate de tener este objeto creado en la Room
    oSimboloDharma.Visible = true;

    // Si usas el sistema del candado:
    // lockDial1 = LOCK_CORRECT1;
  }
  else
  {
    cPaxton.Say("No parece que sea el orden correcto.");
  }

  // Reiniciar para permitir intentarlo otra vez
  bricksPressedCount = 0;
}
function oLadrilloVerde_Interact()
{
  PushBrick(eBrickGreen);
}
function oLadrilloRojo_Interact()
{
  PushBrick(eBrickRed);
}
function oLadrilloAzul_Interact()
{
  PushBrick(eBrickBlue);
}

function MostrarCandadoUI()
{
    oCandadoUI.Visible = true;
    oCerrarCandadoUI.Visible = true;

    oSimboloCristiano.Visible = true;
    oSimboloEstrellaDavid.Visible = true;
    oSimboloLunaIslamica.Visible = true;
    oSimboloYinYang.Visible = true;
    oSimboloRuedaDharma.Visible = true;
    oSimboloCruzRusa.Visible = true;
    oSimboloCruzSerbia.Visible = true;

    candadoCount = 0;
}
function OcultarCandadoUI()
{
    oCandadoUI.Visible = false;
    oCerrarCandadoUI.Visible = false;

    oSimboloCristiano.Visible = false;
    oSimboloEstrellaDavid.Visible = false;
    oSimboloLunaIslamica.Visible = false;
    oSimboloYinYang.Visible = false;
    oSimboloRuedaDharma.Visible = false;
    oSimboloCruzRusa.Visible = false;
    oSimboloCruzSerbia.Visible = false;
}

function PulsarSimbolo(int simbolo)
{
    if (candadoAbierto) return;

    candadoInput[candadoCount] = simbolo;
    candadoCount++;

    if (candadoCount < 3) return;

    // Orden correcto (ejemplo):
    // 1) Rueda Dharma
    // 2) Cruz Rusa
    // 3) Luna Islámica

    if (candadoInput[0] == SIMBOLO_DHARMA &&
        candadoInput[1] == SIMBOLO_RUSA &&
        candadoInput[2] == SIMBOLO_LUNA)
    {
        candadoAbierto = true;
        Display("El candado hace clic y se abre.");
        
        OcultarCandadoUI();
        oTrampilla.Visible = false;
        oTrampillaAbienta.Visible = true;
         cPaxton.Walk(806, 523);
         Wait(500);
      cPaxton.ChangeRoom(8,372,342);  
        // Aquí puedes abrir la trampilla:
        // oTrampilla.Visible = true;
    }
    else
    {
        Display("La combinación no es correcta.");
        candadoCount = 0;
    }
}
function oSimboloCristiano_Interact() { PulsarSimbolo(SIMBOLO_CRISTIANO); }
function oSimboloEstrellaDavid_Interact() { PulsarSimbolo(SIMBOLO_ESTRELLA); }
function oSimboloLunaIslamica_Interact() { PulsarSimbolo(SIMBOLO_LUNA); }
function oSimboloYinYang_Interact() { PulsarSimbolo(SIMBOLO_YINYANG); }
function oSimboloRuedaDharma_Interact() { PulsarSimbolo(SIMBOLO_DHARMA); }
function oSimboloCruzRusa_Interact() { PulsarSimbolo(SIMBOLO_RUSA); }
function oSimboloCruzSerbia_Interact() { PulsarSimbolo(SIMBOLO_SERBIA); }

function oCerrarCandadoUI_Interact()
{
    OcultarCandadoUI();
}



function oCandado_Interact()
{
    MostrarCandadoUI();
}



function oTablon_Look(Object *theObject, CursorMode mode)
{
cPaxton.Walk(881, 623);
cPaxton.Say("En esta madera esta tallada la luna islamica");
}

function room_AfterFadeIn()
{
  
  object[40].Scaling = 200;

  object[41].Scaling = 200;

  cSrReed.AnimationSpeed = 3;
  cPaxton.AnimationSpeed = 3;
  cBarnes.AnimationSpeed = 3;
  cProfeta.AnimationSpeed = 3;
  
  cSrReed.SetWalkSpeed(7, 7);
  cPaxton.SetWalkSpeed(8, 8);
  cBarnes.SetWalkSpeed(8, 8);
  cProfeta.SetWalkSpeed(7, 7);

  lightOn = false;
  candleLit = false;
  prophetResurrected = false;
  lockOpened = false;

  oVelaMesa.Visible = true;
  oTarta.Visible = true;
  oProfetaMuerta.Visible = true;
  oAlfombra.Visible = true;
  oTrampilla.Visible = false;
  oCandado.Visible = false;
  oBengalaSuelo.Visible = false; // se verá solo al mirar la rendija
  oSimbolosPared.Visible = true;
  oLadrillosRGB.Visible = true;
  oTablon.Visible = true;
  oObject0.Scaling = 8000;


  // Secuencia de llegada en oscuridad
  cPaxton.Say("No se ve nada.");
  cBarnes.Say("Busquemos algun interruptor por aqui.");
}

function room_FirstLoad()
{
  oObject0.Transparency = 20;
  oObject1.Transparency=100;
  aMusic1.Play(eAudioPriorityHigh, eRepeat);
}















